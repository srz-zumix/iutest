# C/C++ with GCC
# Build your C/C++ project with GCC using make.
# Add steps that publish test results, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/apps/c-cpp/gcc

# optional make test steps template

parameters:
  options: ''
  package_name: 'default'

steps:
- script: |
    ulimit -c unlimited && ulimit -a
    mkdir -p ~/.config/apport/
    echo [main] > ~/.config/apport/settings
    echo unpackaged=true >> ~/.config/apport/settings
    cat ~/.config/apport/settings
  displayName: 'setup'
  condition: eq(variables['Agent.OS'], 'Linux')
- script: make -C test showcxxversion
  displayName: 'versions'
- script: |
    echo "make -C test -j4 OUTPUTXML=junit ${{ parameters.options }}"
    make -C test -j4 OUTPUTXML=junit ${{ parameters.options }}
  displayName: 'make'
- script: |
    echo "make -C test OUTPUTXML=junit ${{ parameters.options }} ${run_option} test"
    make -C test OUTPUTXML=junit ${{ parameters.options }} ${run_option} test
    TEST_RESULTS=`find ./test -maxdepth 1 -name *.xml 2>/dev/null`
    if [ $? -ne 0 ] || [ -z "$TEST_RESULTS" ]; then echo "##vso[task.setvariable variable=SkipPushTestResult]true"; fi
  displayName: 'test'
  env:
    run_option: RUN_OPTION="--iutest_default_package_name=${{ parameters.package_name }}"
- script: |
    ls /var/crash/
    mkdir test/coredump
    # for file in `find /var/crash/ -name '*.crash'`; do sudo cp $file test/coredump ; done
    for file in `find /var/crash/ -name '*.crash'`; do sudo sed -i -e "s/UserGroups:\s*$/UserGroups:iutest/g" $file ; done
    for file in `find /var/crash/ -name '*.crash'`; do apport-unpack $file test/coredump/`basename $file .crash` ; done
    (cd test/coredump && ls -Ra)
  displayName: 'core dump unpack'
  condition: failed()

- task: PublishPipelineArtifact@0
  condition: failed()
  inputs:
    artifactName: 'core dump'
    targetPath: 'test/coredump'

- task: PublishTestResults@2
  inputs:
    testResultsFiles: 'test/*.xml'

- task: InstallSSHKey@0
  displayName: 'Install SSH Key'
  inputs:
    hostName: 'github.com'
    sshPublicKey: 'not required'
    sshKeySecureFile: 'id_azurepipelines_rsa'

- script: |
    sudo apt-get update
    sudo apt-get install -y hub
  displayName: 'Install Hub'

- script: |
    ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts
    ls ~/.ssh
    git clone git@github.com:srz-zumix/iutest-test-results.git ../iutest-test-result
    git checkout -b ci/azurepipelines/${AGENT_JOBNAME}
    find ./test -name '*.xml' | xargs python ./tools/xml2file/xml2file.py --encoding utf-8 --verbose --clean -o ../iutest-test-result/azure-pipelines/${AGENT_JOBNAME}/
  condition: and(always(), ne(variables['SkipPushTestResult'], 'true'))
  displayName: 'xml to file'

  - script: |
    cd ../iutest-test-result
    find ./azure-pipelines -type f -printf "%T@ %p\n" | sort -nr | cut -d\  -f2-
    git config user.email "zumix.cpp@gmail.com"
    git config user.name "srz-zumix (Azure Pipelines)"
    git add --all
    echo "${BUILD_SOURCEBRANCHNAME}: ${BUILD_SOURCEVERSION}: ${BUILD_SOURCEVERSIONMESSAGE}" > message.txt
    echo >> message.txt
    echo "${BUILD_BUILDURI}" >> message.txt
    git commit -F message.txt
    hub pull-request -m "Azure Pipelines ${AGENT_JOBNAME}"
  condition: and(always(), ne(variables['SkipPushTestResult'], 'true'))
  displayName: 'xml2file push to github pr'
